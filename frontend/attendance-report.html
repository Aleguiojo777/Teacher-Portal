<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Attendance Summary</title>
<link rel="stylesheet" href="portal.css">
<!-- Favicon -->
<link rel="icon" type="image/x-icon" href="resources/favicon.ico">
<link rel="apple-touch-icon" href="resources/favicon-apple.png">
<style>


  .section-select {
    margin-bottom: 20px;
  }

  .section-select label {
    display: block;
    margin-bottom: 8px;
    font-weight: bold;
    color: #374151;
  }

  .section-select select,
  .section-select input[type="date"] {
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #d1d5db;
    font-size: 16px;
    width: 100%;
    max-width: 300px;
  }

  .records-table {
    overflow-x: auto;
  }

  .records-table table {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed;
  }

  .records-table thead tr {
    background: #2563eb;
    color: white;
  }

  .records-table th {
    padding: 14px 12px;
    text-align: left;
    font-weight: 600;
    font-size: 14px;
    border-bottom: 2px solid #1d4ed8;
  }

  .records-table th:first-child {
    width: 5%;
    text-align: center;
  }

  .records-table th:nth-child(2) {
    width: 30%;
  }

  .records-table th:nth-child(3) {
    width: 25%;
  }

  .records-table th:nth-child(4) {
    width: 15%;
  }

  .records-table th:nth-child(5) {
    width: 25%;
    text-align: center;
  }

  .records-table td {
    padding: 12px;
    border-bottom: 1px solid #e5e7eb;
    vertical-align: middle;
    word-wrap: break-word;
    overflow-wrap: break-word;
  }

  .records-table td:first-child {
    width: 5%;
    text-align: center;
    font-weight: 500;
  }

  .records-table td:nth-child(2) {
    width: 30%;
    text-align: left;
  }

  .records-table td:nth-child(3) {
    width: 25%;
    text-align: center;
  }

  .records-table td:nth-child(4) {
    width: 15%;
    text-align: center;
  }

  .records-table td:nth-child(5) {
    width: 25%;
    text-align: center;
  }

  .records-table td:last-child {
    text-align: center;
  }

  .records-table tr:nth-child(even) {
    background: #f9fafb;
  }

  .records-table tr:hover {
    background: #f3f4f6;
  }

  .status-badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: bold;
    text-align: center;
  }

  .status-badge.present {
    background: #dcfce7;
    color: #166534;
  }

  .status-badge.absent {
    background: #fee2e2;
    color: #991b1b;
  }

  .status-badge.late {
    background: #fce7f3;
    color: #be185d;
  }

  .col-5 {
    width: 5%;
  }

  .col-30 {
    width: 30%;
  }

  .col-25 {
    width: 25%;
  }

  .col-15 {
    width: 15%;
  }
</style>
</head>
<body>

<button class="sidebar-toggle" id="sidebarToggle">â˜° Menu</button>

<nav class="sidebar" id="sidebar">
  <div class="sidebar-logo">
    <img src="resources/techvision.png" alt="Teacher Portal Logo">
    <span>Teacher Portal</span>
  </div>
  <ul>
    <li><a href="portal.html">Home</a></li>
    <li><a href="manage.html">Manage Students</a></li>
    <li><a href="attendance.html">Attendance</a></li>
    <li><a href="attendance-report.html">Attendance Summary</a></li>
    <li id="userMgmtNav" class="hidden"><a href="user-management.html">User Management</a></li>
    <li id="logoutNav"><a href="#" id="logoutLink">Logout</a></li>
  </ul>
</nav>

<div class="main-content">
  <div class="container">

<div class="card">
  <h2>Attendance Summary</h2>
  
  <div class="section-select">
    <label for="reportDate">Select Date:</label>
    <input type="date" id="reportDate" onchange="generateReport()">
  </div>
  
  <div class="section-select">
    <label for="reportSection">Select Section:</label>
    <select id="reportSection" onchange="generateReport()"></select>
  </div>
</div>

<div class="card">
  <h2>Attendance Summary</h2>
  <div class="records-table">
    <table>
      <colgroup>
        <col class="col-5">
        <col class="col-30">
        <col class="col-25">
        <col class="col-15">
        <col class="col-25">
        <col class="col-15">
      </colgroup>
      <thead>
        <tr>
          <th>#</th>
          <th>Student Name</th>
          <th>Course</th>
          <th>Section</th>
          <th>Status</th>
          <th>Marked At</th>
        </tr>
      </thead>
      <tbody id="summaryList"></tbody>
    </table>
  </div>
</div>

</div>
</div>
</div>

<script src="portal.js"></script>
<script>
  let allStudents = [];
  let allAttendance = [];

  window.API_BASE = window.API_BASE || (function(){
    try{
      const origin = window.location.origin;
      const host = window.location.hostname;
      if(host === 'localhost' || host === '127.0.0.1') return 'http://localhost:3000/api';
      return origin + '/api';
    }catch(e){
      return 'http://localhost:3000/api';
    }
  })();

  document.addEventListener('DOMContentLoaded', function() {
    const sidebarToggle = document.getElementById('sidebarToggle');
    const sidebar = document.getElementById('sidebar');
    
    if(sidebarToggle && sidebar) {
      sidebarToggle.addEventListener('click', function() {
        sidebar.classList.toggle('show');
      });
      
      sidebar.querySelectorAll('a').forEach(link => {
        link.addEventListener('click', function() {
          if(window.innerWidth <= 600) {
            sidebar.classList.remove('show');
          }
        });
      });
      
      document.addEventListener('click', function(e) {
        if(!sidebar.contains(e.target) && !sidebarToggle.contains(e.target)) {
          sidebar.classList.remove('show');
        }
      });
    }

    // Apply user visibility (show/hide User Management and Logout based on role)
    applyUserVisibility();

    // Setup logout handler
    const logoutLink = document.getElementById('logoutLink');
    if(logoutLink) {
      logoutLink.addEventListener('click', (e) => { 
        e.preventDefault(); 
        logout(); 
      });
    }

    // Set date picker to today
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('reportDate').value = today;

    loadReportData();
  });

  async function loadReportData() {
    try {
      const token = localStorage.getItem('token');
      
      // Load all students
      const studentsRes = await fetch(window.API_BASE + '/students', {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      
      if(studentsRes.ok) {
        allStudents = await studentsRes.json();
        console.log('[DEBUG] Students loaded:', allStudents.length);
      }
      
      loadReportSections();
      generateReport();
    } catch(error) {
      console.error('[ERROR] Failed to load report data:', error);
    }
  }

  function loadReportSections() {
    const select = document.getElementById("reportSection");
    if (!allStudents || allStudents.length === 0) return;
    
    const sections = [...new Set(allStudents.map(s => s.section))];
    select.innerHTML = '<option value="">-- All Sections --</option>';
    
    sections.forEach(sec => {
      const opt = document.createElement('option');
      opt.value = sec;
      opt.textContent = sec;
      select.appendChild(opt);
    });
  }

  async function generateReport() {
    try {
      const token = localStorage.getItem('token');
      const dateInput = document.getElementById("reportDate").value;
      const selectedSection = document.getElementById("reportSection").value;
      
      if(!dateInput) return;
      
      console.log('[DEBUG] Generating report for date:', dateInput, 'section:', selectedSection);
      
      // Load attendance for selected date
      const attendanceRes = await fetch(window.API_BASE + '/attendance/' + dateInput, {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      
      if(!attendanceRes.ok) {
        console.warn('[WARN] Failed to load attendance');
        allAttendance = [];
      } else {
        allAttendance = await attendanceRes.json();
        console.log('[DEBUG] Attendance records loaded:', allAttendance.length);
      }
      
      // Filter by section if selected
      let reportStudents = allStudents;
      if(selectedSection) {
        reportStudents = allStudents.filter(s => s.section === selectedSection);
      }
      
      // Calculate statistics
      let presentCount = 0, absentCount = 0, lateCount = 0;
      
      reportStudents.forEach((student, idx) => {
        const attendance = allAttendance.find(a => a.studentId === student.id);
        const status = attendance ? attendance.status : 'Absent';
        
        if(status === "Present") presentCount++;
        else if(status === "Late") lateCount++;
        else absentCount++;
      });
      
      const total = reportStudents.length;
      const presentPct = total > 0 ? Math.round((presentCount / total) * 100) : 0;
      const absentPct = total > 0 ? Math.round((absentCount / total) * 100) : 0;
      const latePct = total > 0 ? Math.round((lateCount / total) * 100) : 0;
      
      // Display attendance summary table
      const summaryList = document.getElementById("summaryList");
      summaryList.innerHTML = '';
      
      reportStudents.forEach((student, idx) => {
        const attendance = allAttendance.find(a => a.studentId === student.id);
        const status = attendance ? attendance.status : 'Absent';
        
        const row = document.createElement('tr');
        let statusBadgeClass = 'status-badge ';
        if(status === 'Present') statusBadgeClass += 'present';
        else if(status === 'Late') statusBadgeClass += 'late';
        else statusBadgeClass += 'absent';
        
        const markedAt = (attendance && (attendance.createdAt || attendance.updatedAt || attendance.timestamp)) ? new Date(String(attendance.createdAt || attendance.updatedAt || attendance.timestamp).trim().replace(' ', 'T')).toLocaleString() : '';
        row.innerHTML = `
          <td>${idx + 1}</td>
          <td>${student.firstName} ${student.lastName}</td>
          <td>${student.course}</td>
          <td>${student.section}</td>
          <td><span class="${statusBadgeClass}">${status}</span></td>
          <td>${markedAt}</td>
        `;
        summaryList.appendChild(row);
      });
      
      console.log('[DEBUG] Report generated - Present:', presentCount, 'Late:', lateCount, 'Absent:', absentCount);
    } catch(error) {
      console.error('[ERROR] Failed to generate report:', error);
    }
  }
</script>

</body>
</html>
